# ──────────────────────────────────────────────────────────
# Headless reverse-proxy – PrestaShop backend only
# Allows: /admin*, /api, payment webhooks (module/…/payment)
# Blocks:  all other front-office routes
# ──────────────────────────────────────────────────────────
# PRODUCTION SETUP:
#   1. Replace FRONTEND_DOMAIN below with the actual Next.js
#      frontend URL (e.g. https://forestcatering.pl).
#   2. Uncomment the "return 301" line in the catch-all
#      location block and comment out the JSON 404 lines.
# ──────────────────────────────────────────────────────────

map $uri $frontend_redirect_target {
    # REPLACE with actual frontend URL before enabling 301 redirects
    default "https://FRONTEND_DOMAIN";
}

server {
    listen 80;
    server_name _;

    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ── Admin back-office ──
    location ~ ^/admin {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # ── Webservice API ──
    location /api {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # ── Payment webhook callbacks (e.g. /module/*/payment) ──
    location ~ ^/module/.*/payment {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # ── Static assets needed by admin (img, js, css, fonts) ──
    location ~ ^/(img|js|css|themes|modules|upload|download)/  {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ── All other front-office routes → redirect to Next.js or JSON 404 ──
    location / {
        # In production: 301 redirect to frontend domain
        # return 301 $frontend_redirect_target$request_uri;

        # In dev/staging: return JSON 404
        default_type application/json;
        return 404 '{"error":"front-office disabled","message":"This PrestaShop instance runs in headless mode. Use the Next.js frontend."}';
    }
}
